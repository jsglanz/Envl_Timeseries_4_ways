---
title: "Annual Report - Grain Size Heat Maps"
author: "Jess S. Glanz | SMS-BEL Program Coordinator | jess.glanz@gmail.com"
date: "8 Mar 2023"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
mainfont: SourceSansPro
header-includes:
- \usepackage[default]{sourcesanspro}
- \usepackage[T1]{fontenc}
---
## Load the packages

```{r LoadPackages, results="hide",message=FALSE}
library(readxl)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(wesanderson)
```

## Load the data 

Specifically, load the sheet titled "AllDataReady".

```{r LoadData1, results="hide",message=FALSE,warning=FALSE}
gs<-read_excel("~/Desktop/SMS-BEL/SMS-EnvlAnalysis/Data/2022.10.31_CERP_GS.xlsx",sheet=4) 
```

## Tidy the data

Select only the Site, year, and grain size class columns with their proportion of the total weight.

```{r SelectNeededCols, results="hide",message=FALSE,warning=FALSE}
gs1<-gs%>%select(1:2,15:21)
```

Convert the dataframe from wide to long.

```{r RenameColumns, results="hide",message=FALSE,warning=FALSE}
gs1l<-gs1 %>% pivot_longer(cols=`a4`:`g63`, names_to="size",values_to="prop")
```


Convert the proportion values into numeric variables and multiply by 100 to obtain percentage values.

```{r AddQ, results="hide",message=FALSE,warning=FALSE}
gs1l$prop<-as.numeric(gs1l$prop)

gs1l$perc<-gs1l$prop*100
```

Separate past data from the current year's data and omit NA's in the dataframe.

```{r separateCurrentHistorical, results="hide",message=FALSE,warning=FALSE}
gspre<-gs1l%>%filter(Year<2022)
gsprenao<-na.omit(gspre)

gs22<-gs1l%>%filter(Year==2022)
```

Calculate mean percentage of past data for each site and grain size class.

```{r summaryofmean, results="hide",message=FALSE,warning=FALSE}
gssq <- gsprenao %>%
  group_by(Site,size) %>%
  summarize(mean=mean(perc, na.rm=TRUE))
```

Bind the gssq data with the current year's percentage data and rename the added column "perc".

```{r quarterlytickmarkswolabels, results="hide",message=FALSE,warning=FALSE}
gsm22<-cbind(gssq,gs22$perc)

gsm22<-gsm22%>%rename(perc=`...4`)
```

Convert gsm22 from wide to long for plotting purposes.

```{r marginoferror, results="hide",message=FALSE,warning=FALSE}
gsm22l<-gather(gsm22,mp,value,mean:perc,factor_key=TRUE)
```

Add a column called "val" that rounds the mean and current values to one decimal point. These values will be used to label the tiles in the heatmap.

```{r mergeandrename, results="hide",message=FALSE,warning=FALSE}
gsm22l$val<-as.numeric(format(round(gsm22l$value, 1), nsmall = 2))#rounds values to one decimal point
```

## Create heatmaps comparing the current year's values to the historical means, one site at a time.

First, load and name a light tan to dark brown-black color palette.

```{r mypalette, results="hide",message=FALSE,warning=FALSE}
my_wes_palette <- wes_palette("IsleofDogs2", 9, type = "continuous")
```

Then, filter the data for one site.

```{r obtainCIs, results="hide",message=FALSE,warning=FALSE}
gs15l<-gsm22l%>%filter(Site=="M15")
```

And plot the data for that site.

```{r repeatabove, results="hide",message=FALSE,warning=FALSE}
gs15f<-ggplot(gs15l, aes(x = mp, y = size, fill = val)) +
  geom_tile(color = "white") +
  geom_text(aes(label = val,color=val>8.7), size = 4) +
  coord_fixed()+
  labs(x=NULL, y=NULL)+ # New code
  scale_x_discrete(breaks = c("mean","perc"), labels = c(paste("pre-2022"), "2022"))+
  scale_y_discrete(limits=rev,breaks = c("a4","b2","c500","d250","e125","f63","g63"), 
                   labels = c(paste(c(">4mm\n large shell hash, pebbles+",
                                      "2-4mm\n small shell hash, granules",
                                      "0.5-2mm\n coarse-very coarse sand",
                                      "0.25-0.5mm\n medium sand",
                                      "0.125-0.25mm\n fine sand",
                                      "0.063-0.125mm\n very fine sand",
                                      "0-0.063mm\n silt, clay"))))+
  scale_fill_gradientn(name="%Sediment Core",colours = my_wes_palette)+
  theme(panel.background = element_rect(colour = "#471164", size=5),
        plot.margin = unit(c(0, -0.1, 0, 0), "cm"))+#margin(top,right,bottom,left)
  ggtitle("M15")+
  theme(axis.text.y=element_text(size=11),
        #axis.text.x=element_text(size=8),
  plot.title = element_text(hjust = 1, vjust=-0.5)) +
  scale_color_manual(guide = FALSE, values = c("black", "white"))+
  theme(legend.position = "none")
```


Save the plot as a jpg.

```{r selectcurrentvalcolumns, results="hide",message=FALSE,warning=FALSE}
ggsave(
  "gs15.jpg",#file name
  plot = gs15f,#plot to save, defaults to last plot displayed
  device = "jpg",#file format (jpg, pdf, png, eps, etc)
  path = NULL, #defaults to working directory
  scale = 1,
  width =7.5,
  height = 9.5,
  units = "cm", #c("in", "cm", "mm", "px")
  dpi = 300,
  limitsize = TRUE,
  bg = 'transparent')
```

The heatmap below shows that the sediment core collected at M15 in April 2022 had less fine grains and more coarser particles than M15's pre-2022 means.

```{r checkplot, fig.height = 3.74, fig.width = 2.95, out.width = "100%", echo=FALSE,message=FALSE,warning=FALSE}

gs15f

```

